<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>工单分析</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="layui/css/layui.css" media="all" />
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->

</head>

<body>
    <br/>
    <div class="layui-container ultra-layout">
        <br/>
        <div class="layui-fluid ultra-card layui-container" style="padding: 0">
            <div class="layui-row" style="margin-bottom: 10px">
                <ul class="layui-nav layui-bg-cyan">
                    <li class="layui-nav-item ">
                        <a id="href_search" href="./search.html">工单查询</a>
                    </li>
                    <li class="layui-nav-item layui-this">
                        <a id="href_analysis" href="">工单分析</a>
                    </li>
                    <li class="layui-nav-item">
                        <a id="href_worrylist" href="./worrylist.html">工单列表</a>
                    </li>
                    <li class="layui-nav-item">
                        <a id="href_similarworry" href="./similarworry.html">相似工单</a>
                    </li>
                </ul>

                <br/>
                <div class="layui-col-md12" style="background-color: #f5f5f5">
                    <form class="layui-form ultra-form3" lay-filter="searchListFilter">
                        <div class="layui-collapse" lay-accordion="">
                            <div class="layui-colla-item">
                                <h2 class="layui-colla-title">展开查询条件输入框</h2>
                                <div class="layui-colla-content">
                                    <div class="layui-collapse" lay-accordion="">
                                        <div class="layui-colla-item">
                                            <div class="layui-form-item">
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">工单分类：</label>
                                                    <div class="layui-input-inline">
                                                        <select name="categoryName" id="categoryName" lay-filter="categoryName">
                                                        <option value="" selected="selected">
                                                            未选择
                                                        </option>
                                                        <option value="11">未知问题</option>
                                                        <option value="2">程序BUG问题</option>
                                                        <option value="3">投诉建议</option>
                                                        <option value="4">数据修复类问题</option>
                                                        <option value="6">平台类问题</option>
                                                        <option value="7">重复、无效工单</option>
                                                        <option value="8">参数配置问题</option>
                                                        <option value="9">核查类问题</option>
                                                        <option value="1">需求类问题</option>
                                                        <option value="5">操作类问题</option>
                                                        <option value="10">咨询类问题</option>
                                                        <option value="15">非B域问题</option>
                                                    </select>
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">工单内容：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" name="content" placeholder="内容关键字" autocomplete="off" class="layui-input" />
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">关键字：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" name="stream" placeholder="多关键词用空格隔开" autocomplete="off" class="layui-input" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">编号：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" name="processKey" placeholder="请输入编号" autocomplete="off" class="layui-input" />
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">标题：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" name="processTitle" placeholder="请输入标题" autocomplete="off" class="layui-input" />
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">修复场景：</label>
                                                    <div class="layui-input-inline">
                                                        <select name="dataRepair">
                                                        <option value="" selected="selected">
                                                            全部
                                                        </option>
                                                        <option value="1">是</option>
                                                        <option value="0">否</option>
                                                    </select>
                                                        <div class="layui-unselect layui-form-select">
                                                            <div class="layui-select-title">
                                                                <input type="text" placeholder="全部" readonly="readonly" class="layui-input layui-unselect" /><i class="layui-edge"></i>
                                                            </div>
                                                            <dl class="layui-anim layui-anim-upbit">
                                                                <dd lay-value="" class="layui-select-tips">
                                                                    全部
                                                                </dd>
                                                                <dd lay-value="1" class="">是</dd>
                                                                <dd lay-value="0" class="">否</dd>
                                                            </dl>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">发起时间：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" class="layui-input" name="createTime" id="time" value="" placeholder="选择时间范围" />
                                                    </div>
                                                </div>

                                                <div class="layui-inline">
                                                    <label class="layui-form-label">工单状态：</label>
                                                    <div class="layui-input-inline">
                                                        <select name="status" lay-filter="status">
                                                        <option value="" selected="selected">
                                                            全部
                                                        </option>
                                                        <option value="0">待处理</option>
                                                        <option value="1">已解决</option>
                                                        <option value="2">已提供解决方案</option>
                                                        <option value="3">未解决</option>
                                                    </select>
                                                        <div class="layui-unselect layui-form-select">
                                                            <div class="layui-select-title">
                                                                <input type="text" placeholder="全部" readonly="readonly" class="layui-input layui-unselect" /><i class="layui-edge"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">地域：</label>
                                                    <div class="layui-input-inline">
                                                        <div class="layui-input-inline">
                                                            <select name="creatorRegion" lay-filter="provinceCity">
                                                            <option value="" selected="selected">
                                                                请选择
                                                            </option>
                                                            <option value="总部">总部</option>
                                                            <option value="内蒙古自治区">
                                                                内蒙古自治区
                                                            </option>
                                                            <option value="北京市">北京市</option>
                                                            <option value="天津市">天津市</option>
                                                            <option value="山东省">山东省</option>
                                                            <option value="河北省">河北省</option>
                                                            <option value="山西省">山西省</option>
                                                            <option value="安徽省">安徽省</option>
                                                            <option value="上海市">上海市</option>
                                                            <option value="江苏省">江苏省</option>
                                                            <option value="浙江省">浙江省</option>
                                                            <option value="福建省">福建省</option>
                                                            <option value="海南省">海南省</option>
                                                            <option value="广东省">广东省</option>
                                                            <option value="广西壮族自治区">
                                                                广西壮族自治区
                                                            </option>
                                                            <option value="青海省">青海省</option>
                                                            <option value="湖北省">湖北省</option>
                                                            <option value="湖南省">湖南省</option>
                                                            <option value="江西省">江西省</option>
                                                            <option value="河南省">河南省</option>
                                                            <option value="西藏自治区">西藏自治区</option>
                                                            <option value="四川省">四川省</option>
                                                            <option value="重庆市">重庆市</option>
                                                            <option value="陕西省">陕西省</option>
                                                            <option value="贵州省">贵州省</option>
                                                            <option value="云南省">云南省</option>
                                                            <option value="甘肃省">甘肃省</option>
                                                            <option value="宁夏回族自治区">
                                                                宁夏回族自治区
                                                            </option>
                                                            <option value="新疆维吾尔自治区">
                                                                新疆维吾尔自治区
                                                            </option>
                                                            <option value="吉林省">吉林省</option>
                                                            <option value="辽宁省">辽宁省</option>
                                                            <option value="黑龙江省">黑龙江省</option>
                                                        </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">处理人：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" name="username" placeholder="请输入姓名或账号" autocomplete="off" class="layui-input" />
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">处理时间：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" class="layui-input" name="handletime" id="handletime" value="" placeholder="选择时间范围" />
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">幸运鹅：</label>
                                                    <div class="layui-input-inline">
                                                        <input type="text" name="luckyname" placeholder="输入被处理人或者团队" autocomplete="off" class="layui-input" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">处理院：</label>
                                                    <div class="layui-input-inline">
                                                        <select name="org_id" lay-filter="org_id">
                                                        <option value="" selected="selected">
                                                            全部
                                                        </option>
                                                        <option value="00560185693">南京院</option>
                                                        <option value="内蒙古自治区">哈尔滨院</option>
                                                        <option value="北京市">济南院</option>
                                                        <option value="天津市">广州院</option>
                                                    </select>
                                                        <div class="layui-unselect layui-form-select">
                                                            <div class="layui-select-title">
                                                                <input type="text" placeholder="全部" readonly="readonly" class="layui-input layui-unselect" /><i class="layui-edge"></i>
                                                            </div>
                                                            <dl class="layui-anim layui-anim-upbit">
                                                                <dd lay-value="" class="layui-select-tips">
                                                                    全部
                                                                </dd>
                                                            </dl>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="layui-inline">
                                                    <label class="layui-form-label">处理团队：</label>
                                                    <div class="layui-input-inline" style="width: 510px">
                                                        <input type="text" name="department" style="width: 515px" placeholder="请输入处理的团队，多级团队可用空格限制" autocomplete="off" class="layui-input" />
                                                    </div>
                                                </div>
                                                <div class="layui-form-item" style="text-align: right; margin-right: 50px">
                                                    <button class="layui-btn ultra-btn-small ultra-btn-blue layui-btn-radius" lay-submit="" lay-filter="searchListFilter">
                                                    搜索
                                                </button>
                                                    <button type="reset" class="layui-btn ultra-btn-small ultra-btn-default layui-btn-radius">
                                                    重置
                                                </button>
                                                </div>
                                            </div>

                                            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px">
                                                <legend></legend>
                                            </fieldset>

                                            <div class="layui-form-item">
                                                <div class="layui-form-item layui-form-text">
                                                    <label class="layui-form-label">sql语句查询：</label
                                                >
                                                可使用的表：worry（工单主表），worry_item（工单属性表），stream（工单流水表）
                                                <div class="layui-input-block">
                              <textarea
                                      placeholder="请输入sql语句"
                                      name="sql"
                                      class="layui-textarea"
                                      style="width: 515px"
                              ></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div
                                                class="layui-form-item"
                                                style="text-align: right; margin-right: 50px"
                                        >
                                            <button
                                                    class="layui-btn ultra-btn-small ultra-btn-blue layui-btn-radius"
                                                    lay-submit=""
                                                    lay-filter="searchListFilter"
                                            >
                                                查询
                                            </button>
                                            <button
                                                    type="reset"
                                                    class="layui-btn ultra-btn-small ultra-btn-default layui-btn-radius"
                                            >
                                                重置
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <br/>

                <div class="layui-inline">
                    <form class="layui-form ultra-form3" lay-filter="anatype">
                        <div class="layui-form-item">
                            <label class="layui-form-label">* 类型：</label>
                                                    <div class="layui-input-block" id="anaylsis_list_input">
                                                    </div>

                                                    <br/>

                                                    <div style="text-align: right; margin-right: 70px">
                                                        <button type="submit" class="layui-btn layui-btn-radius" lay-submit="" lay-filter="anatype_sub">
                                    分析
                                </button>
                                                    </div>
                                                </div>
                    </form>
                    </div>

                    <br/>

                    <div class="layui-collapse" lay-filter="list">
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">展开工单清单</h2>
                            <div class="layui-colla-content">
                                <table style="width: 500px" class="layui-hide" lay-data="{id: 'processId'}" id="worrylist" lay-filter="worrylist"></table>
                                <div id="worrypage" style="width: 400px"></div>
                            </div>
                        </div>
                    </div>
                    <div id="list_table_analysis"></div>

                    </div>

                    </div>
                    </div>
                    </div>

                    <script src="layui/layui.js" charset="utf-8"></script>
                    <script src="js/analysis.js" charset="utf-8"></script>
                    <script type="text/html" id="ok">
                        <div class="layui-btn-container">
                            <button class="layui-btn layui-btn-sm" lay-event="getCheckData">
            获取选中行数据
        </button>
                            <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">
            获取选中数目
        </button>
                            <button class="layui-btn layui-btn-sm" lay-event="isAll">
            验证是否全选
        </button>
                        </div>
                    </script>

                    <script>
                        var worrys = [];
                        var worrychid = 0;
                        var rowobj;
                        var worryitem;
                        var menuInfo = [];
                        var KEYNAME = {};
                        //页面第一次请求 默认 1页  10条

                        var categoryname = [
                            "需求类问题",
                            "程序BUG问题",
                            "投诉建议",
                            "数据修复类问题",
                            "操作类问题",
                            "平台类问题",
                            "重复、无效工单",
                            "参数配置问题",
                            "核查类问题",
                            "咨询类问题",
                            "",
                        ];

                        var color = "#009688"
                        var $;
                        var index;
                        layui.use(['jquery'], function() {
                            $ = layui.$;
                            let urlticket = getQueryString("ticket");
                            if (urlticket != null) {
                                $("#href_worrylist").attr("href", "./worrylist.html?ticket=" + urlticket);
                                $("#href_similarworry").attr("href", "./similarworry.html?ticket=" + urlticket);
                                $("#href_search").attr("href", "./search.html?ticket=" + urlticket);
                            } else {
                                //第一次点开的操作
                            }

                            function getGuessedState() {
                                $.get("worryarr/getworryitemguess_state?ticket=" + getQueryString("ticket"), function(data) {
                                    if (data.data != null && data.data.finished) {
                                        $(".layui-btn").each(function() {
                                            $(this).addClass("layui-btn-danger");
                                        });
                                        color = "#FF5722";
                                        let html = '<input type="checkbox" lay-verify="analysis_input" name="super"';
                                        html += 'title="分析结果-高级分类"><input type="checkbox" lay-verify="analysis_input" name="base" title="分析结果-基础分类">';
                                        $("#anaylsis_list_input").append(html);
                                        KEYNAME.super = "分析结果-高级分类";
                                        KEYNAME.base = "分析结果-基础分类";
                                    }
                                });
                            }


                            function getAnaMenus() {
                                let html = '<input type="checkbox" lay-verify="analysis_input" name="';
                                $.ajaxSettings.async = false;
                                $.get('catchsupcat?type=gt',
                                    function(data) {
                                        var data = data.data;
                                        menuInfo = data;
                                        menuInfo.forEach(function(data) {
                                            KEYNAME[data.cat] = data.catname;
                                            let temp = html + data.cat + '" title="' + data.catname + '">'
                                            $("#anaylsis_list_input").append(temp);
                                        })
                                        getGuessedState();
                                    })
                                $.ajaxSettings.async = true;
                            }

                            getAnaMenus();
                        });


                        function getQueryString(name) {
                            let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                            let r = window.location.search.substr(1).match(reg);
                            if (r != null) {
                                return decodeURIComponent(r[2]);
                            }
                            return null;
                        }

                        function watchtable() {}
                    </script>
</body>

</html>